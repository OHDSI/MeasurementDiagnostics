---
title: "Summarising measurement use in a dataset"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{summariseMeasurementUse}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", message = FALSE, warning = FALSE,
  fig.width = 7
)

CDMConnector::requireEunomia()
```

## Introduction

In this vignette we will see how we can summarise the use of measurement concepts in our dataset as a whole. For our example we're going to be interested in measurement concepts related to respiratory function and will use the Eunomia synthetic dataset.

First we will connect to the database and create a cdm reference.

```{r, message=TRUE}
library(duckdb)
library(omopgenerics)
library(CDMConnector)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(MeasurementDiagnostics)
library(visOmopResults)

con <- dbConnect(duckdb(), dbdir = eunomiaDir())
cdm <- cdmFromCon(
  con = con, cdmSchem = "main", writeSchema = "main", cdmName = "Eunomia"
)
cdm
```

Now we'll create a codelist with measurement concepts.
```{r}
repiratory_function_codes <- newCodelist(list("respiratory function" = c(4052083, 4133840, 3011505)))
repiratory_function_codes
```

Once we have got the measurement codes we're interested in, we can run our diagnostics on their use in our dataset. We'll simply call the summariseMeasurementUse() function which will run a series of checks for these concepts. Our results are returned in the summarised_result format.
```{r}
repiratory_function_measurements <- summariseMeasurementUse(cdm, repiratory_function_codes)

repiratory_function_measurements |> 
  glimpse()
```

We can see each of the checks performed.
```{r}
settings(repiratory_function_measurements) |> 
  pull("result_type") |> 
  unique()
```

We can see for example a summary of their use.
```{r}
tableMeasurementTimings(repiratory_function_measurements)
```

We can also see for example a summary of numeric values.
```{r}
visOmopTable(repiratory_function_measurements |> 
               omopgenerics::filterSettings(result_type == "measurement_value_as_numeric"))
```

Similarly, we can see a summary of concept values.
```{r}
visOmopTable(repiratory_function_measurements |> 
               omopgenerics::filterSettings(result_type == "measurement_value_as_concept"))
```

